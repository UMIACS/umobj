#!/usr/bin/env python

import sys
import os
import re
import logging
import boto.s3
from boto.s3.connection import S3Connection
from boto.s3.connection import OrdinaryCallingFormat

## Load our local library functions
sys.path.insert(0, "%s/../lib" % os.path.dirname(sys.argv[0]))
from umobj_utils import umobj_logging, umobj_init_keyboard_interrupt, \
    umobj_get_bucket_key_pair_from_string

all_users = 'http://acs.amazonaws.com/groups/global/AllUsers'

usage_string = """
NAME
    %s - List objects in a s3 object store

SYNOPSIS
    %s [OPTION]... [BUCKET][:KEY_PREFIX]

OPTIONS SUMMARY
    -a, --access_key <access_key>  Object store access key
    -s, --secret_key <secret_key>  Object store secret key
    -S, --server <server>          Object store server name
    -P, --port <port>              Object store server port [Default: 443]
    -p, --public                   Show public URLs for the files if available.
    -l, --long                     Use long listing which show full ACL
    -m, --md5                      Show MD5 sum of files if available
    -h, --help

OPTIONS
    access_key  - Your Access Key ID.  If not supplied, boto will
                  use the value of the environment variable OBJ_ACCESS_KEY_ID.
    secret_key  - Your Secret Access Key.  If not supplied, will use the value
                  of the environment variable OBJ_SECRET_ACCESS_KEY.
    server      - The object storage server you want to connect to.  This can
                  be overridden by the OBJ_SERVER environment variable.
    BUCKET      - The bucket that is to be listed.  If no bucket is given it
                  will list all the buckets the user has access to.
    KEY_PREFIX  - Can be specified to exclusively list the sub folder given.
"""


def usage():
    prog_name = os.path.basename(sys.argv[0])
    print usage_string % (prog_name, prog_name)
    sys.exit()


def sizeof_fmt(num):
    for x in ['b ', 'KB', 'MB', 'GB', 'TB', 'PB']:
        if num < 1024.0:
            return "%3.1f %s" % (num, x)
        num /= 1024.0
    return "%3.1f %s" % (num, x)


def list_bucket(b, prefix=None, public=False, long_list=False, md5=False):
    """List everything in a bucket"""
    from boto.s3.prefix import Prefix
    from boto.s3.key import Key
    from boto.exception import S3ResponseError
    total = 0
    query = b
    if prefix:
        if not prefix.endswith("/"):
            prefix = prefix + "/"
        query = b.list(prefix=prefix, delimiter="/")
        print "%s" % prefix
    num = 0
    for k in query:
        num += 1
        mode = "-rwx---"
        if isinstance(k, Prefix):
            mode = "drwxr--"
            size = 0
        else:
            size = k.size
            try:
                for g in k.get_acl().acl.grants:
                    if g.id is None:
                        if g.permission == "READ":
                            mode = "-rwxr--"
                        elif g.permission == "FULL_CONTROL":
                            mode = "-rwxrwx"
            except S3ResponseError:
                mode = "-------"
        if isinstance(k, Key):
            print "%s\t%s\t%010s\t%s" % (mode, k.last_modified,
                                         sizeof_fmt(size), k.name)
            if md5:
                etag = k.etag.strip('\"')
                if re.search('-\d+', etag):
                    print "  MD5: Multipart"
                else:
                    print "  MD5: %s" % k.etag.strip('\"')
            if long_list:
                try:
                    for grant in k.get_acl().acl.grants:
                        print "        %s %s" % (grant.permission, grant.id)
                except S3ResponseError:
                    pass
            if public:
                try:
                    for grant in k.get_acl().acl.grants:
                        if grant.permission == 'READ':
                            if grant.uri == all_users:
                                print "  %s" % k.generate_url(expires_in=0,
                                                              query_auth=False)
                except S3ResponseError:
                    pass
        else:
            #If it's not a Key object, it doesn't have a last_modified time, so
            #print nothing instead
            print "%s\t%s\t%010s\t%s" % (mode, ' '*24,
                                         sizeof_fmt(size), k.name)
        total += size
    print "="*80
    print "\t\tTOTAL:  \t%010s \t%i Files" % (sizeof_fmt(total), num)


def list_buckets(s3):
    """List all the buckets"""
    for b in s3.get_all_buckets():
        print b.name


if __name__ == "__main__":
    import sys
    import os
    import getopt

    umobj_init_keyboard_interrupt()
    level = logging.WARNING

    try:
        opts, args = getopt.getopt(sys.argv[1:],
                                   "a:s:S:P:hplm",
                                   ['access_key=', 'secret_key=', 'long',
                                    'md5', 'server=', 'port=', 'help',
                                    'public'])
    except getopt.GetoptError, err:
        print str(err)  # will print something like "option -a not recognized"
        usage()

    access_key = None
    secret_key = None
    bucket_name = None
    public = False
    md5 = False
    long_list = False
    try:
        server = os.environ['OBJ_SERVER']
    except:
        server = 'obj.umiacs.umd.edu'
    port = 443

    for o, a in opts:
        if o in ('-h', '--help'):
            usage()
            sys.exit()
        if o in ('-a', '--access_key'):
            access_key = a
        if o in ('-s', '--secret_key'):
            secret_key = a
        if o in ('-S', '--server'):
            server = a
        if o in ('-P', '--port'):
            port = a
        if o in ('-p', '--public'):
            public = True
        if o in ('-l', '--long'):
            long_list = True
        if o in ('-m', '--md5'):
            md5 = True

    umobj_logging(level)
    logging.info("Using server %s" % server)
    logging.info("Running %s" % sys.argv)

    if access_key is None:
        try:
            access_key = os.environ['OBJ_ACCESS_KEY_ID']
        except:
            print " ERROR: Please provide access_key"
            usage()
    if secret_key is None:
        try:
            secret_key = os.environ['OBJ_SECRET_ACCESS_KEY']
        except:
            print " ERROR: Please provide secret_key"
            usage()

    obj = S3Connection(host=server,
                       port=port,
                       is_secure=True,
                       aws_access_key_id=access_key,
                       aws_secret_access_key=secret_key,
                       calling_format=OrdinaryCallingFormat())

    if len(args) == 0:
        list_buckets(obj)
    else:
        try:
            bucket_name, key_prefix = \
                umobj_get_bucket_key_pair_from_string(args[0])
            bucket = obj.get_bucket(bucket_name)
        except boto.exception.S3ResponseError:
            print "ERROR: bucket %s does not exist." % bucket_name
            sys.exit(1)
        if not key_prefix:
            list_bucket(bucket, public=public, long_list=long_list, md5=md5)
        else:
            list_bucket(bucket, key_prefix, public=public,
                        long_list=long_list, md5=md5)
