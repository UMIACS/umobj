#!/usr/bin/env python

import boto
from boto.s3.acl import ACL
import sys
import logging

from umobj.utils import umobj_logging, umobj_init_keyboard_interrupt, \
    umobj_get_bucket_key_pair_from_string
from umobj.obj import Obj
from umobj.acl import acl_pairs, split_acl, make_private
from umobj.options import umobj_parser


if __name__ == "__main__":
    umobj_init_keyboard_interrupt()

    description = 'Change Object - ' + \
                  'Modify Access Control lists for a set of buckets and/or keys'
    description_epilog = '''  POLICY      - username:ACL where ACL is one of
                FULL_CONTROL, READ, WRITE, READ_ACL, WRITE_ACL'''
    parser = umobj_parser(description=description,
                          description_epilog=description_epilog)
    parser.add_recursive(help='Recursively apply ACL to keys')
    parser.add_mode(choices=['add', 'remove', 'clear'], help='Mode of operation.  Specifying "clear" will create an empty ACL to be applied.  However, if you specify policies in the same command, the ACL will contain those policies.')
    parser.add_no_bucket_changes()
    parser.add_public(help='Make selected keys public')
    parser.add_private(help='Make selected keys private')
    parser.add_push_bucket_acls()
    parser.add_policy()
    parser.add_s3path(number=1)
    args = parser.parse_args()

    ## setup logging
    if args.debug:
        logging_level = logging.DEBUG
    elif args.verbose:
        logging_level = logging.INFO
    else:
        logging_level = logging.WARNING
    umobj_logging(logging_level)

    logging.info("Running %s" % sys.argv)

    S3PATH = args.S3PATH
    recursive = args.recursive
    mode = args.mode
    public = args.public
    private = args.private
    no_bucket_changes = args.no_bucket_changes
    push_bucket_acls = args.push_bucket_acls
    policies = args.policies

    if not public and not private and not push_bucket_acls:
        if mode is None:
            logging.error('Please provide a mode.')
            parser.print_help()
            sys.exit()

        if policies is None:
            logging.error('One or more ACL policies are required.')
            parser.print_help()
            sys.exit(1)

    if public and mode:
        logging.error('--public and a mode cannot both be specified together.')
        parser.print_help()
        sys.exit(1)

    if private and mode:
        logging.error('--private and a mode cannot both be specified together.')
        parser.print_help()
        sys.exit(1)

    if push_bucket_acls and mode:
        logging.error('--push-bucket-acls and a mode cannot both be '
                'specified together.')
        parser.print_help()
        sys.exit(1)

    if push_bucket_acls and no_bucket_changes:
        logging.warning('--no-bucket-changes cannot possibly have any ' +
                'effect when pushing bucket ACLs.')

    if not Obj.connect(host=args.host,
                       port=args.port,
                       access_key=args.access_key,
                       secret_key=args.secret_key):
        logging.error('Unable to contact object store.')
        sys.exit(1)

    if len(S3PATH) == 0:
        parser.print_help()
        sys.exit(1)

    for bucket_name in S3PATH:
        bucket_name, key_name_prefix = \
            umobj_get_bucket_key_pair_from_string(bucket_name)
        try:
            bucket = Obj.conn.get_bucket(bucket_name)
        except boto.exception.S3ResponseError, e:
            logging.error("Can not access bucket %s, %s." %
                          (bucket_name, e.error_code))
            continue

        # get objects that we are targeting
        objects = []
        if key_name_prefix:
            for key in bucket.list(prefix=key_name_prefix):
                objects.append(key)
        else:
            if not no_bucket_changes:
                objects.append(bucket)
            if recursive:
                for key in bucket.get_all_keys():
                    objects.append(key)

        if push_bucket_acls:
            bucket_policy = bucket.get_acl()

        for object in objects:
            policy = object.get_acl()

            if not mode:
                if public:
                    logging.info('Making %s public' % object.name)
                    object.make_public()
                elif private:
                    logging.info('Making %s private' % object.name)
                    make_private(object)
                elif push_bucket_acls:
                    logging.info('Pushing bucket acls to %s' % object.name)
                    object.set_acl(bucket_policy)
            else:
                # modify acl
                if mode == 'add':
                    for p in policies:
                        u, g = split_acl(p)
                        policy.acl.add_user_grant(g, u)
                elif mode == 'remove':
                    grants = []
                    for grant in policy.acl.grants:
                        for p in policies:
                            u, g = split_acl(p)
                            if grant.permission != g  or grant.id != u:
                                grants.append(grant)
                    policy.acl.grants = grants
                elif mode == 'clear':
                    acl = ACL()
                    for p in policies:
                        u, g = split_acl(p)
                        acl.add_user_grant(g, u)
                    policy.acl = acl 

                try:
                    object.set_acl(policy)
                except boto.exception.S3ResponseError:
                    pass
