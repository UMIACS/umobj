#!/usr/bin/env python

import boto.s3
import re
import sys
import os
import logging
from boto.s3.connection import S3Connection
from boto.s3.connection import OrdinaryCallingFormat

## Load our local library functions
sys.path.insert(0, "%s/../lib" % os.path.dirname(sys.argv[0]))
from umobj_utils import umobj_logging

usage_string = """
SYNOPSIS
   rmobj [-a/--access_key <access_key>] [-s/--secret_key <secret_key>]
         [-S/--server <server>] [-P/--port <port>] [-f/--force]
         [-r/--recursive] [-V/--verbose] [-D/--debug] [-h/--help]
         bucket[:key]+

   Where
        access_key  - Your Access Key ID.  If not supplied, boto will
                      use the value of the environment variable
                      OBJ_ACCESS_KEY_ID
        secret_key  - Your Secret Access Key.  If not supplied, boto
                      will use the value of the environment variable
                      OBJ_SECRET_ACCESS_KEY
        bucket      - The name of the bucket to remove or remove files
                      from.
"""


def usage():
    print usage_string
    sys.exit()


if __name__ == "__main__":
    import sys
    import os
    import getopt

    try:
        opts, args = getopt.getopt(sys.argv[1:],
                                   'a:s:S:P:hrfVD',
                                   ['access_key=', 'secret_key=',
                                    'server=', 'port=', 'help', 'recursive', 'force'
                                    'verbose', 'debug'])
    except getopt.GetoptError, err:
        print str(err)  # will print something like "option -a not recognized"
        usage()

    level = logging.WARNING
    access_key = None
    secret_key = None
    bucket_name = None
    recursive = False
    force = False
    try:
        server = os.environ['OBJ_SERVER']
    except:
        server = 'obj.umiacs.umd.edu'
    port = 443

    for o, a in opts:
        if o in ('-h', '--help'):
            usage()
            sys.exit()
        if o in ('-a', '--access_key'):
            access_key = a
        if o in ('-s', '--secret_key'):
            secret_key = a
        if o in ('-S', '--server'):
            server = a
        if o in ('-P', '--port'):
            port = a
        if o in ('-r', '--recursive'):
            recursive = True
        if o in ('-f', '--force'):
            force = True
        if o in ('-V', '--verbose'):
            level = logging.INFO
        if o in ('-D', '--debug'):
            level = logging.DEBUG

    umobj_logging(level)

    logging.info("Using server %s" % server)

    if access_key is None:
        try:
            access_key = os.environ['OBJ_ACCESS_KEY_ID']
        except:
            logging.error("Please provide access_key")
            usage()
    if secret_key is None:
        try:
            secret_key = os.environ['OBJ_SECRET_ACCESS_KEY']
        except:
            logging.error("Please provide secret_key")
            usage()

    obj = S3Connection(host=server,
                       port=port,
                       is_secure=True,
                       aws_access_key_id=access_key,
                       aws_secret_access_key=secret_key,
                       calling_format=OrdinaryCallingFormat())

    if len(args) == 0:
        usage()

    for bucket in args:
        bucket_match = re.match('(\w+):?([\w\.\-\/]*)', bucket)
        bucket_name = bucket_match.group(1)
        try:
            key_name = bucket_match.group(2)
        except AttributeError:
            key_name = None

        try:
            bucket = obj.get_bucket(bucket_name)
        except boto.exception.S3ResponseError:
            logging.error("Bucket %s does not exist." % args[0])
            sys.exit(1)

        logging.info("Working on bucket %s" % bucket_name)

        if recursive:
            # removing content inside bucket
            ans = None
            if not force:
                if key_name:
                    ans = raw_input(' Are you sure you want to remove all the contents ' +
                                    'of bucket \'%s\' with key prefix \'%s\'? [yes/no] : ' %
                                    (bucket.name, key_name)).lower()
                else: # asking to delete entire bucket since no key specified
                    ans = raw_input(' Are you sure you want to remove all the ' +
                                    'contents of the bucket %s [yes/no] : ' %
                                    bucket.name).lower()
            if ans == 'yes' or force:
                for key in bucket.list(prefix=key_name):
                    if not force:
                        del_key_ans = raw_input('rmobj: delete \'%s\'? [y/n] ' %
                                                key.name).lower()
                        if del_key_ans != 'y':
                            continue
                    logging.info("Deleting key %s" % key.name)
                    bucket.delete_key(key.name)
            else:
                logging.info("Aborting recursive deletion of %s" % bucket_name)
                sys.exit(0)

            # removing the bucket itself
            if key_name:     # if passed a key name, then there are probably still files in
                sys.exit(0)  # the bucket
            ans = raw_input(' Do you want to remove the bucket %s' %
                            bucket.name + ' [yes/no] : ').lower()
            if ans == 'yes':
                obj.delete_bucket(bucket.name)
            else:
                logging.info("Not deleting the bucket %s" % bucket_name)
                sys.exit(0)
        else:  # non-recursive
            if key_name is None or key_name is '':
                logging.error('Can not delete bucket %s.  ' % bucket.name +
                              'please use recursive option.')
                sys.exit(1)
            elif key_name.endswith('/'):
                logging.error('Please use the recursive option to delete a directory')
            logging.info("Deleting key %s" % key_name)
            bucket.delete_key(key_name)
